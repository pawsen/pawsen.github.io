:PROPERTIES:
:ID:       a1b57a39-78a7-4fc0-91a3-546a2a349a52
:DIR:      ../.attach/batteries/
:END:
#+title: batteries

#+MACRO: NEWLINE @@latex:\\@@ @@html:<br>@@
# The top section of a file, consisting of #+, is frontmatter setting or keywords exported to the .md file.

#+HUGO_TAGS: batteries li-ion connectors
#+filetags: batteries li-ion connectors
#+hugo_categories: diy
#+hugo_auto_set_lastmod: t
#+hugo_publishdate: 2024-09-26
#+hugo_bundle: batteries
#+export_file_name: index

Notes about Lithium batteries, connectors and DIY

#+hugo: more

How to assemble Lithium batteries, like the nominal e-bike 36V battery in fig. [[fig:10s4p_liion_battery]].

#+NAME: fig:10s4p_liion_battery
#+CAPTION: 36V 10s4p liion ebike battery
[[attachment:IMG_20211103_180619403.jpg]]

* Connectors
See a list on the [[https://en.wikipedia.org/wiki/DC_connector][Wikipedia article on dc connectors]]

Some of most commonly used for batteries are shown in fig. [[fig:commen_rc_connectors]].

#+NAME: fig:commen_rc_connectors
#+CAPTION: Some of the common RC connectors
[[attachment:image_6dcaf98.webp]]

** JST
A  large number of different types. See [[https://www.mattmillman.com/info/crimpconnectors/common-jst-connector-types/
][this usefule info]]. [[https://en.wikipedia.org/wiki/JST_connector][wikipedia]] has additional info.

Popular types are (with different pin-to-pin pitch)
- SM, wire to wire and locking
- XH, (larger version of the PH) which can be found on aliexpress with 2.54mm pitch that fits with dupont headers.
  (Note that the /official/ connectors has 2.5mm pitch)
- RCY, small 2 position only connector, and like SM is exclusively wire-to-wire.
- 3d printed [[https://www.printables.com/model/475497-angled-jst-tweezers][tweezers]] for easy removal.

** Dupont

https://nerd-corner.com/3d-printed-dupont-connector-for-jumper-cable/
#+CAPTION: 3D printed Dupont connector for jumper cable
[[attachment:Dupont-jumper-cable-case-inside.webp]]
** XT :ATTACH:
XT60 and XT90 are often used for bicycle batteries, as Anderson connectors are considered too bulky(and the ampacity is lower than for e.g. LiFePO4 batteries).
XT's uses(and fits with) bullet connectors.

- 3d printed surface/flush [[https://www.thingiverse.com/thing:3340052/files][mount]] for XT60.
- XT90-s is am anti-spark version of XT90. [[https://www.aliexpress.com/item/1005007308763534.html?src=google][Aliexpress, 10pcs, 10awg silicon wire.]]
- When you are soldering to an XT60 or XT90 it helps to plug them into their
  mate and solder them that way so you don’t overheat the plastic and shift the
  pins. If you don’t have a lot of experience soldering you should just order
  the XT60’s and XT90’s with pigtails.

| model | current rating (A) | wire (AWG) | bullet size (mm) |
|-------+--------------------+------------+------------------|
| XT-30 | 15/30              |      16-18 |                2 |
| XT-60 | 30/60              |      12-14 |              3.5 |
| XT-90 | 60/90              |      10-12 |              4.5 |

If more heavy duty XT-like connectors are needed, the [[https://www.google.com/search?q=QS8+connector][QS8 connector]] carries 110A, up to 6AWG wire and are anti-spark

#+CAPTION: XT90 vs QS8 anti-spark
[[attachment:xt90_vs_qs8_antispark.jpeg]]

There is a plastic cap for wall mounted XT connectors
- search for =XT60E-F cover= on AliExpress (or =XT60E-M cover= for the male version). =E= is for panel-mount,

#+CAPTION: XT60E-F and XT60E-M with cover. Also available for XT90
[[attachment:XT60E-F_M_cover.png]]

| Model    | description                        |
|----------+------------------------------------|
| XT60 F/M | Original                           |
| XT60H    | "Housing" version with snap-on cap |
| XT60E    |  Panel-mount                                   |


** Anderson :ATTACH:
Relevant here are the Powerpole(single pole) and SB(two or three poles) series, see fig [[fig:anderson_single_vs_multipole]]
The connectors are genderless/hermaphroditic. See [[https://www.ctals.com.au/collections/what-size-anderson-plug][info]] and [[https://en.wikipedia.org/wiki/Anderson_Powerpole][wikipedia]] for area of uses.


#+NAME: fig:anderson_single_vs_multipole
#+CAPTION: Powerpole and SB multipole
[[attachment:single-Pole-vs-Multi-Pole-B.jpeg]]

- Single/Powerpoles can be stacked into any configuration or keying you want, by
  locking the housings into each other, in rows or columns, and rotated from 0
  to 90 to 180 to 270 degrees from each other.
- Single/Powerpoles don't directly have a way to screw the housings to things,
  but there are hardware pieces available to lock them together, and to mount
  them to surfaces. If you have at least three housings in a row, you can put
  screws thru the retaining pin holes to mount it to a surface.
- You can create a four pin connector by screwing two SBs together back to back. You can "key" this connector in four ways depending on the rotation of each of the two.

NOTE:
 - There's different keying for each colors of the SB series, so they cannot be interchanged(except black and grey), see fig. [[fig:anderson_colour_keying]]
   The colors also correspond to different suggested voltages.
 - The plugs comes with different pin fits, i.e. the SB50(50A) have plugs for 6, 8 and 10-12 awg cables.

#+NAME: fig:anderson_colour_keying
#+CAPTION: Different keying for each colour in the *SB50* series
[[attachment:_20240218_023440220px-Anderson_SB50_Colour_Keying.jpg]]

- Buy them from [[https://www.aliexpress.com/item/1005005237025318.html][aliexpress]], remember to select AWG size for the pins.
- The SB connectors can be flush mounted. Here's a 3d model from [[https://www.thingiverse.com/thing:5835998/files][thingiverse]]
** Coaxial / DC barrel
[[https://en.wikipedia.org/wiki/Coaxial_power_connector][Also known as barrel connectors, concentric barrel connectors or tip connectors]].

#+CAPTION: DC barrel jack male, 5.5mm outer, 2.1mm inner
[[attachment:barrel-plug-dims.png]]

The most common sizes are

#+CAPTION: CUI's standard barrel plug offering: (top) outer diameter (middle) inner diameter (bottom) CUI part number designation
[[attachment:cui-standard-barrel.png]]

Note the *yellow tip* connectors on the right, they are [[https://www.accesscomms.com.au/eiaj-rc-5320a-plugs/][EIAJ RC-5320A]] plugs, different from the standard CUI standard.

The current rating for barrel connectors varies but will often be ⋜5A, primarily dependent on the spring force. More expensive connectors can be up to 10A, found on digikey or mouser.
They are borderline ok to use for charging LiIon batteries.

- [[https://www.aliexpress.com/item/1005008726633507.html][DC Power Socket Plug, 5.5*2.5]]
- [[https://www.aliexpress.com/item/10000006487848.html][Waterproof cap DC099, DC Power Jack]]

The wire from the charge port should 18awg. 20awg might be sufficient but only if there's no peak current >5A.

** Crimpers
Three recommended crimpers that can crimp most things
- [[https://www.amazon.com/Insulated-Non-Insulated-Klein-Tools-1005/dp/B0006M6Y5M][Klein Tools 1005]], for 10-22 AWG or the cheaper [[https://www.amazon.com/dp/B00004SBDI][Channellock 909 9.5-Inch Wire Crimping Tool]] (I bought the latter)
  Note: There's die for insulated and non-insulated connectors. The die possitions are (possible) reversed on the Klein- vs Channellock tool. That's the only difference between them.
- [[https://www.amazon.com/gp/product/B017S9EINA][Hexagon crimping tool]], for 2-10 AWG, (iCrimp Cable Lug Crimping Tool, this version have AWG sizing. It can be found with [[https://www.12voltplanet.co.uk/copper-tube-terminal-hexagon-crimping-tool-6-50mm2.html][mm2 sizing]] as well)
  For crimping Andersen Connectors pins, set the die to one size smaller than the actual pin, i.e. for 6awg(16mm2 with mm2 sizing), set the die to 4awg(10mm2), as recommended in [[https://youtu.be/cTRYkjGKx0M?feature=shared&t=117][this video]].
- [[https://www.amazon.com/IWISS-Ratcheting-Anderson-Connectors-CONNECTORS/dp/B01MSQPTDS][Anderson connector tool]], for 15, 30 and 45 A connectors(10-22 awg wires).
  Apparently these Anderson connectors requires a specific tool for crimping. This tool should be good and less expensive than the original.


Other good crimpers
For large sizes
- [[https://www.amazon.com/TEMCo-Lug-Crimper-Tool-TH0020/dp/B00HJYY5GA][Dieless cable lug crimper]]. Heavy duty, makes very good [[https://youtu.be/uuTRLQOa5zk?feature=shared][crimps]] even when lug and wire doesn't match exactly.
- [[https://www.aliexpress.com/item/4001255674082.html][IWISS IWS 38 crimper]] (choose the 38 version).

For ferrules
(Ferrules are the thin tubular end connectors used on cables that are going to mounted in screw terminals. Also called bootlace terminals)
- [[https://www.amazon.com/IWISS-Self-adjusting-Hexagonal-AWG23-10-End-sleeves/dp/B00H950AK4][iCrimp HSC8 6-6A]], hexagonal crimping tool
  The 6-6 stands for 6 ridges, 6 sides. The hex one.
  The 6-4 stands for 6 ridges, 4 sides. The square one.
  Go for the hexagonal one.

  The leading 6 is probably related to the max. size of the cable, i.e. the higher number, the larger diameter cable.
  
* Wires :ATTACH:
Use [[https://en.wikipedia.org/wiki/American_wire_gauge#Tables_of_AWG_wire_sizes][wikipedias table of AWG wires]] to get initial recommendation.
And depending on length, use the

#+NAME: fig:awg_selection_chart
#+CAPTION: AWG selection chart.
#+CAPTION: [[http://assets.bluesea.com/files/resources/newsletter/images/DC_wire_selection_chartlg.jpg][source]]
[[attachment:_20240218_005227DC_wire_selection_chartlg.jpg]]

** discharge
For short cable lengths the main limiting factor is the temperature rating of the insulation. That's why silicon insulated wire can handle amps.

- For silicone insulated wire, 30A for 12 AWG, 60A maximum for short periods, 20A for 14AWG.
- For PVC insulated wire, 15A for 14AWG, 20A for 12AWG (same as house wiring, since the insulation temp ratings will be the same)

  For current higher than 30A continuously, use XT90 connectors
- XT90 with 10AWG silicone wire is great at up to 50A continuously

* Strips
Strips are used to spot weld battery cells together.

Pure nickel is the most common, but [[https://endless-sphere.com/sphere/threads/copper-nickel-sandwich-buses-for-series-connections.108006/][copper/nickel sandwich]] can be used if high current is needed.

The parallel connections can be just about any material that is conductive, since the current is quite small for all cells (less than 1A under all conditions). Nickel, and nickel-plated steel ribbon will work quite well for paralleling. They act as a resistor to slow cell equalization.

However, the series connections handle the current of the pack, so using copper is the best material for high performance batteries.

#+CAPTION: Series current flow is 5A, for a total of 25A for this 5p battery. Parallel current(equalizing) is less than 1A.
#+CAPTION: {{{NEWLINE}}}
#+CAPTION: If the cells are 3400mAh, peak capacity is /(5p x 3.4Ah = 17Ah/).
[[attachment:Battery186508.webp]]


#+CAPTION: Conductivity in IACS (International Annealed Copper Standard)
| % IACS | Material   |
|--------+------------|
|    100 | Copper     |
|     61 | Aluminum   |
|     27 | Zinc       |
|     22 | Nickel     |
|      5 | Iron-Steel |


Fig [[fig:ampacity_chart_strips]] shows the ampacity for different materials.

#+NAME: fig:ampacity_chart_strips
#+CAPTION: Conductor Strips Ampacity Charts (ratings are relatively conservative)
#+CAPTION: {{{NEWLINE}}}
#+CAPTION: https://endless-sphere.com/sphere/threads/nickel-strip-ratings.98849/post-1447486
[[attachment:Ampacity (Powestream extrapolation).jpg]]
** Nickel strips
:PROPERTIES:
:ID:       1de1b8e1-6474-4c69-b92e-63cbeea311a9
:END:
If using nickel, make sure it is pure nickel strips as it can carry a higher current than nickel plated steel strips.

*** Dimensions

According to the table in fig [[fig:ampacity_chart_strips]], pure nickel strips of =8mm x 0.15mm= carries 4.9A, which is sufficient for my bike batteries.

Rule of thumb
- 8x0.15mm for 5A (per 8A rated cell)
- 8x0.20mm for 10A rated
- buy 8mm wide nickel for straight packs and 10mm for honeycomb packs

**** Some notes
Some testing at endless-sphere shows that =7mm x 0.15mm= is good for about 7A and becomes hot @ 10A.

But consider this, before choosing a thinner strip:

Current flows in series in a battery pack. A strip that connects one cell to the other in series might only be 3cm long, but...there are 15 of them in a 14S 52V pack.

If the controller and motor are drawing 30A, then pass 30A at 52V through 45cm of nickel strip to see if there is any voltage drop. Now try 50A and see how much voltage drop there is. If you are happy with the results, then you will be fine.

Note that if you make longer connections, the strip resistance increases linearly with length and so does the overall ohmic heat and therefore losses.
*** Pattern
For DIY batteries there are three basic "brick" layouts, ie layouts that results in a rectangular battery.

- square
- W or Wave
- oblique/slanted row

In the picture horizontal layers are parallel and vertical layers are in series.
The difference between =wave= and =oblique= is where the "flat edge" will be in the battery. For =wave= the flat end is along the series connection, while =oblique= is flat along the parallel.

For most higher voltage batteries, like 10S5P, it would make sense to use =wave= layout as there is half the waste of space.

#+CAPTION: Cell layouts, t) brick, m) Wave, b) oblique
[[attachment:cell-layouts.webp]]

*** ascii representation
Yeah, I wasted time doing this.

All schematics are 4S3P, seen from the top.
The cell is  =0─[    ]─X 3.7v=, ie =0= is the negative and =X= is the positive terminal.

#+CAPTION: Square
#+begin_example
    0 - 0 - 0    11.1V - 14.8V
    |   |   |
S   X - X - X    7.4V -  11.1V
^    (connected on the rear side)
|   0 - 0 - 0    3.7V -   7.4V
|   |   |   |
|   X - X - X    0V    -  3.7V
-----> P
#+end_example

#+CAPTION: Wave
#+begin_example
    0       0   11.1 - 14.8V
    | \   / |
    |   0   |
    |   |   |
    X   |   X
      \ | /
        X
        (connec.)
    0       0
    | \   / |
S   |   0   |
^   |   |   |
|   X   |   X   0 - 3.7
|     \ | /
|       X
----> P
#+end_example

#+CAPTION: Oblique
#+begin_example
    0 - 0 - 0    11.1 -  14.8V
     \   \   \
S     X - X - X   7.4 - 11.1
^    (connected on the rear side)
|   0 - 0 - 0     3.7 -  7.4
|    \   \   \
|     X - X - X   0V  -  3.7
-----> P
#+end_example

*** Test if the strip is pure nickel
As nickel and nickel plated steel are extremely difficult to difference at sight, there are an easy homemade test that could be done in order to check if you have one or another.

This doesn't discard the steel for welding purposes: if the strips are in good condition would be enough for batteries that will be used *only* in dry environments.
**** The salt water test - corrosion
Take a strip sample and polish / scratch with a dremel tool or simply with a knife on a small area, and put into salty water for 12h to 24h.

#+CAPTION: Pure nickel and nickel plated steel strips in salt water
[[attachment:DSC_1394_E.jpg]]

**** The sanding/grinding wheel test - sparks from grinding
Nickel plated steel strips should give sparks if grinded with a dremel sanding wheel.
Pure nickel should not give sparks.
But use the salt water test as well.
** copper

Copper foil is inexpensive and readily available as a bus material, but it is notoriously difficult to weld directly to the ends of battery cells, because of the low resistance (resulting in low heat loss).

A popular way to still use copper is [[https://endless-sphere.com/sphere/threads/copper-nickel-sandwich-buses-for-series-connections.108006/][copper/nickel sandwich buses]], where the copper is overlaid with 0.1mm nickel-plated steel strips at the cell tips.

#+CAPTION: copper/nickel bus
[[attachment:BatteryCopperNickel1.jpg]]

0.15mm copper appears to be reliably welded when all of the components are optimized. That thickness of copper will support the highest-amp 21700 cell.
Another option is to [[https://endless-sphere.com/sphere/threads/copper-nickel-sandwich-buses-for-series-connections.108006/page-6#post-1690164][DIY nickel electroplating copper]] strips.


I have read that the slot in the nickel strip makes the current take the shortest path, which is though the tip of the cell, during a spot weld. This should reduce the wear on the spot welder electrodes.
#+CAPTION: The slot in the nickel strips ensures that most current travels through the shorter path of the cell tip.
[[attachment:SpotWeldCurrent1.png]]

* Cells
** Types
There are many different li-ion type cells
#+CAPTION: Different types of LI-ION cells
[[attachment:aQnIswu.png]]

#+CAPTION: Voltage and Chemistry
| Voltage | Chemistries           |
|---------+-----------------------|
| 2.5 V   | Titanate (LTO)        |
| 3.2 V   | LiFePO4 (LFP)         |
|         | LiFeYPo4 (Thundersky) |
| 3.6 V   | LiCoO2 (LCO)          |
|         | LiNiMnCoO2 (NMC)      |
|         | LiMnO2                |
|         | LiMn2O4 (LMO)         |
|         | LiNiCoAlO2 (NCA)      |

Regardless of chemistry, they come in different formats
- Pouch: soft plastic bag (incorrectly called "LiPos")
- Small cylindrical: in metal case, no studs, less than 10 Ah (e.g.: 18650)
- Large cylindrical: in plastic case, two threaded studs at either end, 10 Ah and larger
- Small prismatic: housed in a thin metal (or plastic case), less than 10 Ah (e.g.: cell phone)
- Large prismatic: housed in a hard plastic (or thin metal) case two bolts at top, 40 Ah and larger, used in electric vehicles, solar system

** 18650 and 21700
For most hobbyist, ~18650~ used to be the most popular but ~21700~ are getting more popular for ebikes due to the higher energy density.

The names are from the form factor, ie
- 18650 measures 18 mm in diameter by 65 mm in length, giving them the name 18650.

#+CAPTION: The two electrodes of a standard 18650 cell. The bottom and sides of the shell are the negative electrode. The negative side is protected by a thin PVC sleeve.
[[attachment:Battery1865018.webp]]

I have read that: *Do not spot weld or solder onto the center of the negative end of a cell*
#+begin_quote
    During assembly, when the jelly roll is inserted into the negative metal shell, a probe is inserted down the center and the “tab” for the negative electrical connection is bonded to the shell at the bottom-center of the 18650 cell. If you screw around with the center of the bottom of the 18650 cell, there is a chance you might loosen the internal connection between the jelly roll and the metal shell.    
#+end_quote
Soldering onto the positive end should be ok.

Some prefer to use(ie. would newer build a pack without) [[https://endless-sphere.com/sphere/threads/18650-insulator-rings-redundant.100867/][fiber washers]] on the positive end to prevent shoulder shorts
#+CAPTION: Shoulder short: while trying to prying the nickel bus, the plier broke the pvc sleeve and shorted the cell.
[[attachment:18650cellShort.webp]]

Some recommended cells are listed below. Other good cells can be found on [[https://www.e-cigarette-forum.com/blog/moochs-recommended-batteries.7593/][Mooch's recommended batteries]] list.
*** 18650

#+CAPTION: Recommended high discharge cells
| Rating (A) | models                            | capacity (mAh) |
|------------+-----------------------------------+----------------|
|         10 | LG MJ1, Samsung 35E, Panasonic GA |           3400 |
|         15 | 30Q                               |           3000 |
|         20 | Sony VTC6, LG HG2, Samsung 25R    |                |

*** 21700

| Rating (A) | models             | capacity (mAh) |
|------------+--------------------+----------------|
|       14.6 | LG M50LT [[https://www.nkon.nl/en/m50lt.html][link]]      |           4932 |
|         35 | Samsumg 50S ([[https://www.nkon.nl/en/samsung-inr21700-50s-5000mah-35a.html][link]]) |           5000 |

** Cell arrangement/holder
https://e4bike.ru/page/battery-shape-configurator
https://www.repackr.com/
[[https://docs.google.com/spreadsheets/d/1e2962wuNumstvv6UMLi-F7xVHQFWlMr1/edit#gid=1526562313][Repackr with IR and 80x14.xlsm]]

*** honeycomb
The side angle of the stacked cells is about 30-degrees for honeycomb configuration, (compared to 90-degree corners in a common rectangular pack).
This makes it a natural fit into the lower part of the frame triangle space, as seen in fig. [[fig:honeycomb_stack]].

#+NAME: fig:honeycomb_stack
#+CAPTION: Picture from a Russian battery pack website: figure out how many cells fits in your frame
#+CAPTION: {{{NEWLINE}}}
#+CAPTiON: https://e4bike.ru/page/battery-shape-configurator
[[attachment:Battery18650Allex.webp]]

Supplier of honeycomb configuration plastic cell holders, plus 30-degree angled nickel bus-strips
https://www.aliexpress.com/item/18650-battery-holder-Cylindrical-cell-2-10-plastic-holder-18650-lithium-ion-battery-bracket-plastic-case/32729220653.html
** Voltage


#+CAPTION: Nominal, max and min voltage.
#+CAPTION: Based on 4.2V for fully charged and 3.0V for empty cell.
| Voltage (V) | Cells (s) | Max (V) | Min (V) |
|-------------+-----------+---------+---------|
|          24 |         7 |    29.4 |    21.0 |
|          36 |        10 |    42.0 |    30.0 |
|          44 |        12 |    50.4 |    36.0 |
|          48 |        13 |    54.6 |    39.0 |
|          52 |        14 |    58.8 |    42.0 |
|          60 |        16 |    67.2 |    48.0 |
|          72 |        20 |    84.0 |    60.0 |
|          88 |        24 |   100.8 |    72.0 |
#+TBLFM: $3 = $2*4.2;%0.1f
#+TBLFM: $4 = $2*3.0;%0.1f

See the [[https://talesontwowheels.com/2019/10/02/li-ion-ebike-battery-charge-charts/][battery charge charts]].

** Voltage sag

https://electronics.stackexchange.com/a/463453

** Reusing old cells :ATTACH:

This flow chart might help deciding if the cells are worth reusing

#+CAPTION: flow chart for testing used batteries
#+CAPTION: {{{NEWLINE}}}
#+CAPTION: https://secondlifestorage.com/index.php?threads/18650-harvesting-flow-charts.9714
[[attachment:_20240117_134522index.php.jpeg]]

*** Internal resistance
DC and AC IR, [[https://secondlifestorage.com/index.php?threads/dc-ir-vs-ac-1kh-ir-measurements.9471/post-64654][thread]]. Theoretical info on how to measure IR can be found in this paper, [[https://sci-hub.se/10.3390/s100605604][Comparison of methods for determining IR]]

Use the AC IR as screening tool before the C/D/C (charge/discharge/charge) cycle. Too high internal resistance and the cell should be discarded.

The advantage of AC IR is that the cell can be tested at a lower voltage and still give accurate results. The same cannot be said for DC IR, where the cell needs to be charged.

**** AC IR :ATTACH:

AC IR is most useful as a coarse first-level screening tool, to weed out unhealthy or damaged cells. It cannot be used for more refined analyses because it does not incorporate the non-ohmic components of IR

However, this [[https://docs.google.com/spreadsheets/d/1n6DU0VC7Yjksz2ah90VUcpw6SW6kFqQt/edit#gid=1042577799][IR cheat sheet]] give maximum and optimal AC IR values for different cells. And this [[https://secondlifestorage.com/index.php?threads/dc-ir-vs-ac-1kh-ir-measurements.9471/post-66400][post]] shows that AC & DC IR correlates(shown below as well)
#+CAPTION: AC & DC IR measurements
[[attachment:_20240117_15553520341-0abdeb4398e2d17212a3aa109e6b96a9.jpg]]

#+CAPTION: SOH vs AC & DC IR
[[attachment:_20240117_1551034755-1d484a0665d4c8b6866f08dc47a918e6.jpg]]

The current observation is that AC IR so far has been a very good indicator of a cells SOH with DC IR confirming it.
AC IR can indicate a cells SOH even at low V i.e. a cells cutoff V of ≈2.8V to 2.5V and even below that, where DC IR needs the cell to be at least ≈3.2V to get a reasonably respectable reading.

**** dc IR
DC IR match real life usage of cells best, but it's time consuming, requires 30<SoC<80% and expensive equipment to measure. [[https://secondlifestorage.com/index.php?threads/opus-bt-c3100-wire-mod-results.9374/post-64352][This post]] shows how DC IR changes for low and high SoC
30<SoC<80% correspond approximately to OCV of 3.8-3.9V. See the link in the OCV section.

- *Low frequency*, ie 1Hz, AC-IR is a valid alternative for DC-IR measurement
- AC-IR reduces measurement time dramatically
- Possible to measure resistance of 1mΩ or less accurately
- 4-terminal pair test leads required to measure low resistance with AC-IR
- the cheap standard 1kHz ac IR measuring device does not correlate with DC IR. (ie. emphasise the low frequency of 1Hz)
**** importance of IR matching
It is known that poor (DC) IR matching can lead to significant reduction in life, e.g. below
#+begin_src quote
Gogoana et al. [13] cycle-aged two cylindrical lithium iron phosphate (LFP) cells connected in parallel. They found that a 20% difference in internal resistance resulted in a 40% reduction in the useful life of the pair of cells compared to if the cells had approximately equal internal resistances. The authors attribute this to the uneven current distribution between the cells. Their results highlight that each cell will go through periods where it experiences high currents that will in turn age the cells more quickly.

Gong et al. [1] drew similar conclusions from their experimental work with 32 Ah cells. When two cells with a 20% impedance difference were connected in parallel, the peak current experienced was 40% higher than if the cells were identical. The authors also performed simulation studies, using the Mathwork's Simscape extension to Simulink to connect two equivalent circuit models (ECMs) in parallel. This is one of the few examples of parallel cell modelling within the literature from Modelling and experimental evaluation of parallel connected lithium ion cells for an electric vehicle battery system
#+end_src
https://sci-hub.se/http://dx.doi.org/10.1016/j.jpowsour.2016.01.001

*** Repacking
See [[https://docs.google.com/spreadsheets/d/1e2962wuNumstvv6UMLi-F7xVHQFWlMr1/edit#gid=1526562313][Repackr with IR and 80x14.xlsm]] for creating matching battery packages.
Found from https://drive.google.com/drive/folders/1UOQUXa4Kwa99KoeuNDe7EV3iSECb8iIs

** SoC or State of Charge :ATTACH:
*** Open Circuit Voltage :ATTACH:
Lead-acid batteries have a relatively discharge linear curve, which allows a good estimation of the state of charge.
Lithium-ion batteries have a much flatter discharge curve, which means that over a wide operating range, the voltage at the battery terminals changes very slightly.

#+CAPTION: Open Circuit voltage, liion VS Lead Acid
[[attachment:_20240117_141842OCV-vs-SOC-EN.png]]


Experimental OCV vs SoC is found [[https://lygte-info.dk/info/BatteryChargePercent%20UK.html][here]](see *tables*  section after the images) and summarized here
#+CAPTION: Estimated remaining capacity, OCV
[[attachment:_20240117_142835BatteryChargePercent.png]]

*** Coulomb Counting

To track the state of charge when using the battery, the most intuitive method is to follow the current by integrating it during cell use. This integration directly gives the quantity of electrical charges injected or withdrawn from the battery, thus making it possible to precisely quantify the SoC of the battery.

Small measurement errors may occur, related to the sampling frequency. To correct these marginal errors, the coulomb counter is recalibrated at each load cycle.
** SoH or State of Health

SoH = Q_{max} Q_{rated}

** notes
- https://www.electricbike.com/inside-18650-cell
- [[https://youtu.be/9qi03QawZEk][Why lithium batteries dies]]
- [[https://youtu.be/CxS7XeIh_i4][What is inside a 18650 cell]]
* BMS
The Battery Management System (BMS) should prevent under- and overvoltage and balance the cells.

#+NAME: fig:li-ion_bms_cables
#+CAPTION: BMS balancing wires taped to the cells(note the cells are in honeycomb arrangement)
[[attachment:BatteryDIY11.webp]]

The unmodified [[id:7b290853-736d-431c-aded-8eaf12f0fec2][BBS models (BBS02/BBS02B/BBSHD)]] uses up to 30A, but the BBSHD can be modified to >50A.
So get a BMS that delivers >50A

Recommendations

** ANTBMS
[[https://antbms.aliexpress.com/store/1102984145][ANTBMS]], like the 7-16S 80A
** JKBMS
- [[https://www.aliexpress.com/item/1005004233638105.html][JKBMS accessory RS485 CAN Module and LCD Display Adapter USBRJ45]]
- [[https://www.aliexpress.com/item/1005007345361911.html][B2A8S20P]], 4-8S, 200A, 2A balancing, heating
** JBDBMS
Almost all the cheaper 'smart' bluetooth BMS are a JBD based BMS. The other vendors just add their own things on top. [[https://www.aliexpress.com/item/1005004634019368.html][QUCC]] should be good, but a bit more expensive that barebone JBD.

This JBD 7-14S is awesome
[[https://www.aliexpress.com/item/1005004892183305.html][JBD Bluetooth mini BMS 7-14S with on/off SW]], Size:63*52*12mm.
* Displays
** Open Circuit Voltage
- [[https://www.aliexpress.com/item/1005005479929375.html][Battery Voltage Capacity Indicator LCD Display Tester]] (doesn't seem to have on/off button)
- [[https://www.aliexpress.com/item/1005008406091763.html][3S-14S DC7-55V Battery Level indicator]] (cheaper, with on/off button)
* LiFePO4 in car

** charger
https://www.sportsmobileforum.com/forums/f20/installing-a-kisae-dmt-1250-dc-to-dc-charger-24264.html

** battery

All prices in EUR
| Name                | Description                                               |  price | url                                                                                                          |
|---------------------+-----------------------------------------------------------+--------+--------------------------------------------------------------------------------------------------------------|
| Battery             | 12V, 100A, LiFePO4 with Temp Protection,                  |    289 | https://www.litime.de/products/litime-12v-100ah-tm-lifepo4-batterie-tieftemperaturschutz-fur-trollingmotoren |
| Inverter            | Pure sine, 1000W. Try to search for a used                |    138 | https://www.ebay.de/itm/203074673536                                                                         |
| 230V charger        | 14.6V, 20A, XT60 and eu plug                              |   53.7 | https://www.aliexpress.com/item/32831716444.html                                                             |
| dc-dc charger       | 14.6V, 10A                                                |   50,4 | https://www.aliexpress.com/item/1005006128785637.html                                                        |
| 60A Circuit breaker | 12V, between alternator/starter battery and dc-dc charger |    3.8 | https://www.aliexpress.com/item/1005006161099930.html                                                        |
| 200A mega fuse      | 12V, between battery and inverter,                        |   1.16 | https://www.aliexpress.com/item/1005006113042292.html                                                        |
| XT60 connector      | 5 pcs, pairs                                              |   0.46 | https://www.aliexpress.com/item/1005005643878854.html                                                        |
| battery voltmeter   | Alt. use Coulomb counter. See link below                  |   4.66 | https://www.aliexpress.com/item/1005005210816625.html                                                        |
| 2AWG cables         | 2x, connecting battery to inverter, 30 cm, 115A @ 75℃     |  2*2.4 | https://www.aliexpress.com/item/1005005741206301.html                                                        |
| 10AWG cable         | connecting charger plug to battery, 2m, 35A @ 75℃         |   14.8 | https://www.aliexpress.com/item/1005001732356744.html                                                        |
| 14AWG cable         | connecting charger plug to battery, 2m, 20A @ 75℃         |    5.9 | https://www.aliexpress.com/item/1005001732356744.html                                                        |
| usb PD charger      | SW3518s module, only buck, 2 channel 100W                 |     10 | https://www.aliexpress.com/item/1005004331359699.html                                                        |
| boost converter     | 50W, for boosting input to SW3518s from 12V to 21V        |      2 | https://www.aliexpress.com/item/1005003044909360.html                                                        |
|---------------------+-----------------------------------------------------------+--------+--------------------------------------------------------------------------------------------------------------|
| total               |                                                           | 582.28 |                                                                                                              |
#+TBLFM: @>$3=vsum(@2..@-1)

1. The battery is recommended by https://www.mobile-solarpower.com/lithium-batteries.html
   That's Will Prowse,https://www.youtube.com/@WillProwse. According to Reddit he's legit.
2. The mega fuse between battery and inverter:
        Let's pretend we have a 1500W inverter
        1500W / 12V = 125A
        125A X 1.25(safety factor) = 156.25A
        choose 200A
3. usb PD charger: there's a *difference* between SW3518s and SW3518
4. The ampacity for the cables are from https://en.wikipedia.org/wiki/American_wire_gauge#Tables_of_AWG_wire_sizes
5. Alternative DC chargers
   https://www.amazon.com/Renogy-Battery-Batteries-Multi-stage-Charging/dp/B07Q5VYPCF


Alternatives
| Name                 | Description                       | price | url                                                      |
|----------------------+-----------------------------------+-------+----------------------------------------------------------|
| coulomb counter      | Instead of voltmeter              |    14 | https://www.aliexpress.com/item/1005005297360206.html    |
| dc-dc charger        | 3A, CC CV                         |   2.4 | https://www.aliexpress.com/item/1005004022655532.html    |
| dc-dc charger        | deluxe, 8A                        |    65 | https://powerwerx.com/dcdc-charger-lifepo4-8a-adjustable |
| dc-dc charger        | 30A, choose without bluetooth&nfc |   112 | https://www.aliexpress.com/item/1005002247278366.html    |
| dc-dc charger        | 8A, looks ok for the price        |    45 | https://www.aliexpress.com/item/1005005705151923.html    |
| car fuse, mini blade | 5A or 7.5A, 10 pcs                |   4.3 | https://www.aliexpress.com/item/1005006215756284.html    |
| male car plug        |                                   |   0.8 | https://www.aliexpress.com/item/1005006368260359.html    |
| female car plug      |                                   |   0.5 | https://www.aliexpress.com/item/1005005077776924.html    |
** diy :ATTACH:

[[https://diysolarforum.com/threads/horseflys-cabin-solar-lifepo4-upgrade.27472/][Build with heating pads]]. See schematic below and the last page in the post for update: Only one temp. sensor is necsecary
#+CAPTION: Battery with heating pads
[[attachment:LFP_Cell_Layout3_230Ah_Box_Side_View2.png]]

#+CAPTION: Battery box, top view. Note how the cells are connected
[[attachment:LFP_Cell_Layout3_230Ah_Box_TopView_w_covers.png]]

** bus bar :ATTACH:
Homemade busbar of braided copper

#+CAPTION: bus bar
[[attachment:nickel_pated.jpg][nickel_pated.jpg]]

take the (annealed) copper pipe, start flattening it in a (hydraulic) vise until it's 'flat' but not closed so you can slide the braid in (the full length of the pipe segment, in this case 25mm). Then compress the pipe segment with the braid. After compression you get a cold weld - internally, it will look like this:
#+CAPTION:  cold welded 'annealed copper pipe' together with the braided strands.
[[attachment:weld.jpg]]

The copper braid is 25 mm2 equivalent, but it's 25 mm wide x 2 mm thick. It's rated at 150A. Link: https://www.copperbraid.co.uk/product/flat-super-flexible-25-mm2/

Nickel plating was done with nickel acetate, made with vinegar and a pure nickel bar used for electroplating

#+CAPTION: Assembled battery with flexible bus bars.
[[attachment:20210422_130857.jpg]]

Consider using [[https://mgchemicals.com/products/grease-for-electronics/electrically-conductive-grease/conductive-paste/][Conductive Assembly Paste 847]] between the bus bar and terminals. Might equalize any potential issues from not having perfectly flat bus bars or difference in resistance contact from cell to cell.
** Portable powerbank
https://www.facebook.com/groups/215409542709308/permalink/1124136908503229/

#+CAPTION: DIY 7s powerbank with 4000W inverter
[[attachment:336641969_260578612981094_4576794305281260481_n.jpg]]

#+CAPTION: DIY 7s powerbank with 4000W inverter
[[attachment:341332985_249482387540216_4869565342427987087_n.jpg]]

- 200Ah LifePO4, 7s
- [[*JKBMS][JKBMS + display]]
- inverter MppSolar 4000W.
* Pouch cells
- [[https://youtu.be/01GqOijUC-s][lithium ion NCM prismatic pouch battery build]] ::
  assembling the cells, creating custom circuit boards, and securing them with rivet nuts.
-

* tech
** Wire batteries in parallel :ATTACH:
Pull from +ve on one battery and -ve of the other battery to ensure even load/wear/resistance
[[attachment:_20240206_203635How-to-Wire-Batteries-in-Series-and-Parallel-Image-11.jpg]]
* fuses :ATTACH:
A single 180Ah cell shot-circuit using a wrench submerged in water. The cell delivered 2500A, about 13C. This is done using a older cell(video is from 2011), a newer cell might deliver closer to 20C.

For big packs, like a 2p 280A, could potentially deliver 12kA at 20C. Only T-class fuses have this high Ampere Interrupt Capacity(AIC) and is especially recommended for 48V systems. Here's a [[https://diysolarforum.com/threads/mrbf-or-class-t.47659/post-606422][table of AIC]] for relevant fuses and be sure to check this post about [[https://diysolarforum.com/threads/class-t-vs-anl-fuse.13913/post-640573][Bussman BS88 and NH style fuses]] that is a cheaper alternative to T-class. [[https://diysolarforum.com/threads/class-t-vs-anl-fuse.13913/post-657800][link to buying 180LET]](BS88 style).

The main thing a Class T (and BS88) fuse offers over Mega for the same AIC is that they are faster. This means that in addition to protecting the wiring (typical use of the fuse) they can also protect the silicon (like a BMS).

180LET on [[https://www.digikey.dk/en/products/detail/eaton-bussmann-electrical-division/180LET/1876565][digikey]], [[https://www.eaton.com/content/dam/eaton/products/electrical-circuit-protection/fuses/bussmann-series-catalogs/bus-ele-cat-1007-flc-2018.pdf][datasheet/catelog(p.89)]] or [[https://www.eaton.com/us/en-us/skuPage.180LET.html][manufacture]].

#+CAPTION: LET BS88, page 89 of the datasheet
[[attachment:let_bs88.png][let_bs88.png]]


| Category                   | Type     |                  Ratings(A) |
|----------------------------+----------+-----------------------------|
| Blade                      | Mini     |                        2-30 |
| Blade                      | Standard |                        1-40 |
| Blade                      | Maxi     |                      20-120 |
|----------------------------+----------+-----------------------------|
| Link                       | Strip    |                      30-100 |
| Link                       | Midi     |  30-150(32V) OR 30-100(58V) |
| Link                       | Mega     | 40-500(32V) OR 125-300(58V) |
|----------------------------+----------+-----------------------------|
| ANL                        |          |                        -500 |
|----------------------------+----------+-----------------------------|
| Cooper Bussmann MRBF fuses |          |                             |
|----------------------------+----------+-----------------------------|
| T-rated                    |          |                             |

Remember to select the correct voltage as well

Blade fuses are now the most commonly used category of fuses with almost every
new vehicle featuring one or more of the different types. They push-fit into
fuse holders or boxes and are held in place by friction.

The ANL fuse is a bolt-down fuse and can be an alternative for the MEGA fuse and
is a fast acting fuse. ANL fuses are good for any bigger loads such as
Inverters, charge controllers, power distribution panels, or as the main battery
/ system fuse.

Calculate fuse size for a high frequency inverter (ex. 3500W)
3500 ac watts / .85 conversion factor / 20 volts low cutoff = 205.882352941 service amps.
205.882352941 service amps / .8 fuse headroom = 257.352941176 fault amps.

#+CAPTION: https://diysolarforum.com/threads/class-t-vs-anl-fuse.13913/page-3#post-326485
[[attachment:_20240309_172628Choose_the_Fuse_Amperage.jpg]]
** estimating short circut current

https://diysolarforum.com/threads/class-t-vs-anl-fuse.13913/post-390863
#+begin_quote
A battery's short circuit current is typically estimated by dividing its open circuit voltage by its internal resistance. While the true DC internal resistance can be determined using a series of discharge tests, it is often simpler to directly measure the battery's impedance or conductance using an AC test signal.
#+end_quote

Example:
3.2V cell with IR of 0.25mOhm and busbar with a resistance of 0.15mOhm (including terminal to busbar resistance) can produce no more than 3.2V / 0.40mOhm = 8kA. It doesn't matter how much you put in series - the current can not go over 8kA with these numbers.
Putting another battery in parallel double the current.

Preece's Law can be used to generate an estimate for the approximate dc fusing current for a given wire size and material. It has been found that the dc fusing current for a straight wire element depends upon it's diameter as given by Preece's Law.

I = a*d^{3/2}.

I is the fusing current, d is the diameter of the wire, a is a constant depending on the material of the wire.

** Fusing individual cells

For powerwalls made of recycled cells of varying/unknown quality, fusing each cell is recommended. According to the following video it is not necessary to fuse both sides of the battery. One side is enough.
[[https://youtu.be/iL6Td8R5C1g][Dead shorting an 18650 Battery to test cell level fuses]]

5 Amps is sufficient

Three types of cell fuse
- [[https://batteryhookup.com/products/nickel-fuse-2p-wide-continuous-roll-by-the-foot-18650-cell-level-fusing][Nickel fuse, continuous roll]]
- Fuse wire, like 30AWG tinned copper. [[https://www.amazon.com/gp/product/B01LZBOSQJ][30AWG on amazon]] and [[https://youtu.be/QWZKIr5BcU0][fuse wire test]]. The [[https://en.wikipedia.org/wiki/American_wire_gauge#Tables_of_AWG_wire_sizes][fusing current is seen in this table]]
  Can be either spot welded or soldered between battery and bus bar. [[https://secondlifestorage.com/index.php?threads/experiment-soldering-18650-capacity-fade.8217/][Welding should not decrease battery performance]] if done properly
- Glass fuses. Some recommend these over fuse wire, as they don't heat/glow. I prefer the fuse wire for ease of installation and it's neater.

*** images :ATTACH:
#+CAPTION: Spot welded fuse wire to bus bar
[[attachment:20220713_190008.jpg]]

#+CAPTION: soldered fuse wire to solid bus bar
[[attachment:BatteryFuse1.webp]]

#+CAPTION: Fusing current for AWG wires. From https://en.wikipedia.org/wiki/American_wire_gauge#Tables_of_AWG_wire_sizes
[[attachment:AWG-wire-sizes.jpg]]

#+CAPTION: nickel fuse strip
[[attachment:strip.jpg]]

* Inverters
** High frequency
High frequency inverters are generally more complex on the electronics side but do away with the giant, heavy copper transformer that a low frequency inverter uses.

** Low Frequency
Uses a giant, heavy copper transformer.

Can handle high surge currents from e.g. motors and compressors, but they tend to have slightly less efficiency and higher no-load idle power consumption.

LF inverters are best for running a house off of.
*** MUST EP3000 6kW, 18kW peak inverter
Has the added advantage of also being able to work as a battery charger when coupled to the generator.
It is heavy weight (45kg) and uses around 50W in indle power. Ask for spare parts for the inverter and order a replacement power and control board.
[[https://offer.alibaba.com/cps/a26g1gth?bm=cps&src=saf&url=https%3A%2F%2Fwww.alibaba.com%2Fproduct-detail%2FMUST-EP3000plus-1KW-2KW-3KW-4KW_1600447397373.html][alibaba link]].

Make sure to get the newer *plus* version and not the older *pro*.
https://www.mustsolar.com/must-products-updated-ep3000-plus/

See [[https://diysolarforum.com/threads/this-could-be-interesting.7835/post-190627][this post]] for inside pictures of the inverter. Note the big and heavy coil.
See [[https://github.com/PurpleAlien/must-power_grafana][his github]] for grafana plugins/modbus protocol to read from the MUST devices. He uploaded a description of the [[https://diysolarforum.com/resources/must-ep3000-modbus-rtu-protocol.308/][modbus protocol]] and [[https://diysolarforum.com/resources/must-ep3000-plus-inverter-charger-1-6-kw-version.98/][manual]].

* power tools batteries
See this [[https://docs.google.com/spreadsheets/d/e/2PACX-1vRghl-44o7Nw_GGOGKN8PdnxJtbzF7UR7nYDt3zEPrRL_azznKE1w4QvBJRLxdQnecwIgQ6tuuzQ4bT/pub#][Spredsheet]] with battery and cell information for most brands, like Milwaukee, DeWALT, etc.

NOTE!
Only Makita 18V and Ryobi 18V have low voltage protection built into the battery.

Get a [[https://www.aliexpress.com/item/1005001327267228.html][BMS]] or a [[https://www.amazon.com/Digital-Battery-Low-Voltage-Protection/dp/B07929Y5SZ][low voltage protector disconnect]](XH-M609 on [[https://www.aliexpress.com/item/1005005374391032.html][aliexpress]]. Btw description says it is good for 20A, but then the traces will get really hot. Add wires or use it with a relay or stay below 10A). There are triangle shaped BMS for M12.  Search for "M12 bms milwaukee" on aliexpress.

Add 3.3K resistors over cell connections on the BMS, to trick it into thinking cells are connected, like shown in this [[https://youtu.be/T8lREgBeVL8?si=s5w2zCnubRzsJ_Nn&t=66][video]].

** Milwaukee
- Milwaukee M12 batteries have no BMS inside. The only component is a thermistor for overheat/low temp protection. All battery intelligence is in the tools and chargers.
- M18 have a BMS. However, some intelligence such as low voltage disconnect is in the tool. Makita and Ryobi keep the low voltage disconnect inside the batteries, making them great for DIY projects. Connecting loads directly to a Milwaukee M18 or M12 terminals without low voltage cutoff circuitry will overdischarge and ruin the battery.

Cutoff voltage for M12 is around 9.74V(The tool will no longer turn). Set it to 10V to be on the safe side. Most 18650 cells can run down to 2.7V without destroying them, but going so low (ie. 3*2.7V=8.1V) could destroy some cells if they are slightly out of balance.
* powerbank
[[https://www.thingiverse.com/thing:6953712][1S8P case]], [[https://www.aliexpress.com/item/1005003384846487.html][LED Dual USB 5V 2.4A Micro/Type-C USB Mobile Power Bank 18650 Charging Module]]
* cases
- [[https://www.alibaba.com/product-detail/YIXIANG-EU-USA-STOCK-48V-280_1601375351894.html][YIXIANG 48V diy box]]
* Load testing
** ATORCH
- [[https://www.aliexpress.com/item/1005001445448822.html][Atorch DL24P 180W]]

Long [[https://www.eevblog.com/forum/testgear/cheezeball-dc-load-dl24p-pump-or-dump/][eevblog.com thread on DL24P]]

Keep the load under 100W or even less with higher voltages.
To get stable dissipation, use the CC-mode and a power resistor in series to the electronic load.
If you e.g. use a 50Ω-resistor in series with the load and set the current to 1A with 60V of source voltage, then 50W are dissipated at the resistor and 10W at the MOSFET.

To get a higher load capacity, the [[https://www.aliexpress.com/item/1005004773128494.html][DL24EW]] can be spliced with [[https://www.aliexpress.com/item/1005004536206429.html][DL24MP]] modules. Note there is a purple and black version. Up to [[https://www.reddit.com/r/18650masterrace/comments/1irbyyw/attorch_dl24ew_3000w_load_tester/][3000W]].

#+CAPTION: ATORCH electronic load testers
[[attachment:atorch_electronic_load_tester.webp]]


** Software / data collector
- [[https://lygte-info.dk/project/TestControllerIntro%20UK.html][lygte-info.dk Test controller]]

* Notes

Paralleling, serialing, balancing, BMS
http://liionbms.com/php/white_papers.php

http://liionbms.com/php/bms_options.php

Professor Jeff Dahn of Dalhousie University delivered a lecture entitled "Why do Li-ion batteries die and can they be immortal?".
https://www.youtube.com/watch?v=9qi03QawZEk&t=1s
